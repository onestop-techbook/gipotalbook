# Hasuraを構築する（モブ#12 7/30)

連休やなんやらで少しあきましたが、今日はHasuraを構築し、実際にページとして表示します。

みんなで使えるGraphQLサーバーを立ててみましょう。

Hasura.cloudというのはあるのですが、月99ドルからなので現実的ではありません。ローカルで立ててもデプロイの問題が出てくるので、Herokuでやってみます。

規模が難しいとか何か機能として無理になるとかの問題が生じたらその時考えることにしましょう。

## Herokuをみてみる
Herokuでやってみることにします。まずは、料金などの確認です。ギポタルでチームを作ります。５ユーザーまでは無料のチームが作れるようです。ただし、クレカ登録が必要です。一旦かからないけど、チーム人数が超えた時などに請求される形だと考えられます。

とりあえず、いまは個人IDで動作の練習とデプロイを確認してみます。まずは、ID作って、ログインをします。

### GraphQLをデプロイする
HasuraからHerokuにデプロイするチュートリアルがあり、その中にデプロイするボタンがあるので、ここからデプロイします。

https://hasura.io/docs/1.0/graphql/manual/deployment/deployment-guides/heroku.html

とりあえずギポタルに干渉しない名前をつけておいて、Deploy appをクリックすると、デプロイされます。Dockerのログが走り、しばらくすると完了し、Hasuraのコンソールが見れるようになります。

無料プランではHerokuの資源が若干貧弱なため起動には多少時間がかかりますが、Hasuraのコンソールが見れれば完了です。本当にワンクリックでできたよ、とみんなから驚きの声も。

あとは、Hasuraの画面からテストデータを作ります。Add new tableから模擬データを作ります。この辺りは、過去のモブでやったところですね。

ところでここで、データタイプの型にName型というのがあることに気づき、なんじゃこりゃ、とう話も出ます。まあテキストでいいですよね。となります。

idとnameを適当に作って模擬データとします。たくさんありすぎても仕方ないので、二つ三つです。

そして、GraphQLのURLをコピーして、VS codeのindex.tsの中にある、URLを書き換えます。

Next.jsの画面を更新すると、データが読み込まれ、先ほど入力したデータが表示されれば成功です。

万全を期すたえHasuraにデータを追加して、再度更新してみます。追加したデータを含めて表示されることを確認すれば万全です。

### GraphQLのURLを隠す
このGraphQLは表示して良いものでしょうか？不用意なアクセスによるセキュリティリスクもありますから、隠すことも検討します。とりあえず隠匿できるように。.env設定もやってみます。

プロジェクトのルートに.envというファイルを作ります。

```js .env
GRAPHQL_URL = "https://hoge.heroku/hoge"　//変更後1
NEXT_PUBLIC_GRAPHQL_URL = "https://hoge.heroku/hoge"　//変更後2。OK
```

```js index.tsx
  url: https://hoge.heroku/hoge, //もと
  url: process.env.GRAPHQL_URL,　//変更後1、クライアントサイドに公開されるのでNG
  url: process.env.NEXT_PUBLIC_GRAPHQL_URL,　//変更後2、OK
```
としてみます。が、これでは動きません。Nextを再起動したところで。起動ログに.envが読み込まれている記載があったのでその点は問題ありません。

これが動かないNEXT.jsはサーバーサイドにもクライアントサイドにも利用されるのですが、変更後の環境変数がクライアントに公開されてしまうことになります。そこで、環境変数をクライアントサイドに公開するのかしないのかを指定する必要があるのです。

なお、隠匿するものだけでなく、環境ごとに変えたいといったときにも使えます。

HasuraのURLは隠匿するようなものでもないので、このままPushしておきます。今後隠匿が必要なものが生じたらそのときに設定します。

ただし、.envはGitHubの無視するファイルに含まれています。ですからリポジトリで公開する場合に追跡されません。

これでは他に使ってみようと思った人が困ってしまいます。そこで、`.env.exaple`を作り、公開しておくとともにセットアップ方法をReadmeに記載します。初めてリポジトリ

```sh
$ npm install 
$ cp .env.example .env
# ローカルでHasuraを立ち上げる人のために
$ docker-compose up
# ここに一つ足りないものががある
$ npm run dev
```

環境変数を設定するところを作っておきますが、動かすにはまだ一つ手順が足りません。

それは、立ち上げたHasuraにダミーデータを作るところです。また、安全に立ち上げるためにはデータのインポート・エクスポートができる必要があります。

そこで、一旦環境変数を構築、というところでコミットしておきます。

``` .gitignore
# dotenv environment variable files 
.env*
!.env.example
```
として、`.env`は無視するが、`.env.example`は無視から除外し追跡・アップロードできます。

一旦これでおしまいですね。

### リポジトリの名前を変える
Tech-book-portalというリポジトリ名だったのですが、正式名称も決まったことですし、リポジトリ名自体を変えます。

```sh
git config -e
```

これで設定項目が開きますから、`[remote "origin"]`の中に記載されているURLを新しいリポジトリに変更します。viで開いてしまったため、viの使い方講座が始まったのは別の話。

## HasuraのSchemaをどうやって管理する？

