# サーバーにデプロイ　モブ#13　8/13
いよいよ今日は本番サーバーにデプロイします。

HerokuにTeamを作り、Hasuraを組み込みます。また、Vercelを使って自動デプロイするところが今日の目標です。

## HerokuにTeamを作りデプロイする
Hasura/Graphqlをデプロイします。これ自体は前回いちどやってますが、個人IDでの実施でしたから、まずはHerokuにTeamを作ります。

Teamにすることで、複数の人でアクセスできます。5人までは無料ですので、ユーザーを招待します。

再度、Hasuraからワンクリックでのデプロイができますので、今回もこれを使います。

名前をGipotalとして、Hasuraをデプロイします。

![herokuへデプロイ](chap-mob-0813/heroku1.png?scale=0.8)

デプロイにはしばらく時間がかかりますので、しばし待ちます。

その間に、Vercelを準備します。これは、連携したGitHubリポジトリを自動でビルドしてくれたり、デプロイしてくれたりする素敵なツールです。

大変便利なのですが、FreeプランではOrganizationを連携させることはできないので、有料プランとしました。月20ドルというのが少し痛いところではありますが、むしろ開発とマネタイズへのモチベーションとなりますので、さくっと払ってしまいます。

GitHubの連携設定をはじめます。


![Vercelの設定](chap-mob-0813/vercelSetting1.png?scale=0.5)

GitHubのリポジトリを選択し、Deployします。

```js package.json 
    # Scripts内
    "prebuild": "npm run codegen",
```

また、codegen.yml内のSchemaURLをHerokuのHasuraのGraphqlのURLに書き換えます。

これで再度走らせると、インストールが進みますが、Resource not foundが返ってきます。DB本体が存在しないためのエラーですから、再度手動ポチポチでデータを入れましょう。

![Vercelの設定完了](chap-mob-0813/verceldone.png?scale=0.8)

入力されたデータが表示されたので、一旦これでOKですね。

#### [column] Windowsで上手くいかなかった話

一度なぜかエラーが出てうまくいかないということがありましたが、GitHubの設定から一度削除して再度やってみたところ、デプロイはされました。ただし、途中でエラーで止まってしまい、Package.jsonへの追加を行います。

ギポタルのGitCloneからはじめます。

ターミナルからnpm iでインストールしようとしますが、上手く入らない・・・回線が重いのとは別に、Next.jsのバージョンの問題などでおやかたのPCでローカル環境を作ることは諦めました。残念。

WSL2でやるとかMacでやるとか、いろいろやったほうがいいのだけど・・・Macが楽よねーというコメントが随所から出て、今回は諦め。

モブだからやる気もわいてくるし、他の人に教えてもらいながらなのでトライアンドエラーが可能ですが、一人でやるのは本当につらいですね・・・

JavaScriptはRuby以上にWindowsに冷たいという印象がある、なんていうコメントが出ましたが・・・

#### [/column]

## Herokuにアクセス制限をかける
現状、Herokuにアクセス制限がかかっていないため、誰でもフルアクセスができてしまいます。

アドミン権限を付けましょう。

Hasuraの画面から、Request Header>Config varsに`HASURA_GRAPHQL_ADMIN_SECRET`を設定することで、Consoleにアクセスできなくなります。

Consoleにアクセスできなくなるのは良いのですが、今度は読み出しもできなくなってしまいました。ポータルサイトの機能を考えると、これ出は困ります。一般ユーザー/閲覧者の読み出し権限をつける必要がありますね。

現在の問題は二つ、

* Hasuraに認証をかけたいが、読み出しにも認証がかかってしまう
* 今HerokuにデプロイされているHasuraはMigrationに対応していない。

一つ目は、やり方がわかってないので、まずはHasura、認証回りについて調査します。

二つ目は、7/30のモブでやったMigration対応がまだ反映されてないという状態ですから、書き換えたほうをDeployするようにする必要があるようです。

## 8/13　今日のまとめ
HerokuへのHasuraの設定、Vercelでの自動デプロイ、Hasuraにパスワードをかける(ただし読み取りも不可なので設定途中)までできました。次回は、アクセス制限の対応です。

![8月13日のFun done learn](chap-mob-0813/0813_fundonelearn.png?scale=0.8)

宿題事項を書いて、Fun done learnをやって、本日はおしまいです。