# Hasuraの認証　モブ#14　8/20

今日の内容は、Hasuraの認証回りの設定と、今後のリリース方針についての相談です。今回から新しいお友達が参加しました。Aizackさんです。今回新刊としてHeroku本を書いてらっしゃるというまさかのタイムリーさで、なにとぞーという感じで参加です。いらっしゃいませありがとうございます。

## Hasura/Graphqlに適切な権限をつける
セキュリティ上の寒天からConsoleにアクセス制限をつけたところ、未認証ユーザーも見れなくなってしまいました。そこで今日は最初にHasuraの権限回りを整理します。

認証ユーザーにはAuth0などを使って適切な権限をつける必要もありますが、未認証ユーザーにも適切な権限(例えば読み取りのみ)をつける必要があります。

SettingsにConfig varsに環境変数を追加します。

key: HASURA_GRAPHQL_UNAUTHORIZED_ROLE
value: anonymous

を追加します。

次に、Permissionを設定します。

テーブルの中にprofileを開き、ここにPermissionを設定します。

Enter new roleに先ほど設定したanonymousを入力し、読み取り権限であるselectを追加します。

![hasuraへのパーミッション設定](chap-mob-0820/hasura1.png?scale=0.8)

今はidとNameしかありませんが、この後様々なキーが追加されたときに、必要な項目だけに権限をつけるといったことができるはずです。



![hasuraへの詳細な権限の設定](chap-mob-0820/hasura2.png?scale=0.8)

また、パーミッションを変更してみます。たとえばidは読めますがNameを読めなくしてみましょう。

この時は、クライアント側でエラーが出ますので、正しい挙動です。

これをつけることで、Vercelにデプロイしてあるページのテストページでデータが呼び出せることを確認して、完成です。さっくりできましたね。

ここで少し、認証回りの話になります。日本で比較的よくつかわれているのはFirebase authやAuth0で、機能や求めるものによりますが、どちらかがよさそうですね、ということで落ち着きます。他にも認証プロバイダはありますが、このどちらかで進めればよさそうです。値段に関してはFirebase authの方が安そうですが、Auth0のフリーでもそこそこ使えそう、だけど調べてみましょう、という状況です。

Firebase authであろうとAuth0であろうと、Roleを作ってくれるわけではないので、Hasuraの方で様々な条件を作っていくのでしょう。

データ書き込みはまだできていませんので、アプリ側で認可を実装する必要があります。


まずは、先週の課題解決おめでとうございます！


## 自動デプロイ回り
マイグレート回りは、本日お休みのえるきちさんが来てからということになり、今日の宿題を再確認します。

![今日の宿題](chap-mob-0820/hasura2.png?scale=0.8)

マイグレートをGitHubから自動デプロイする方法などが宿題になるので、これはあと回しです。

現在の構造として、GitHubの同じリポジトリの中にHasuraのマイグレートのデータと、アプリケーションが同居しています。アプリケーションの方は、Vercelにより自動的にデプロイされるようになっています。

ローカルのHasuraで変更したものを自動的にHerokuにデプロイしてほしいと考えています。単純にやるだけなら、GitHub連携ができますし、Pipelineを設定することもできます。永続的に立っているHerokuに対して、GitHubActionsを使ってデプロイするようにしてみます。

HasuraCLIでリモートのHasuraにマイグレートを仕掛けるコマンドが用意されているようですのでこれについても調査します。公式動画で確認します。GitHub Actionsでたたけそうなイメージができたので、とりあえずやってみます。ステージングでマイグレーションファイルを自動で出す設定になっていて、Config.ymlでEndPointを本番環境に差し替えてその状態でHasuraCLIを叩いたら本番に適用できたね、といった感じの動きと認識しました。

ここでドライバーを交代し、やってみます。リポジトリをローカルにCloneして、HasuraCLIをインストールして、まず認証エラーが出ることを確認します。

$ hasura migrate status
cannot create maigrate instance: [access-denied] ristricted access

## β版リリース方針について話す
本日2020年8月20日で、この後の予定として、9月12日からの技術書典9があります。それに向けて、ギポタル自体のβ版リリースをどうするのか、合わせてギポタル本のリリースをどうするのか、という点についての相談をします。

まずはギポタルのβリリースについてですが、当初に決めたMVP(Minimum Viable Product)として、技術書典に合わせてリリースしたいところです。技術書典はコロナ影響でオンライン開催となりました。この時期はこの界隈は技術書に関する話題で盛り上がりますから、この時期に